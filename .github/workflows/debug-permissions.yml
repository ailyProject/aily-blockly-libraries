name: Debug Permissions

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

jobs:
  debug-permissions:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Debug GitHub Context
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          console.log('ğŸ” è°ƒè¯•GitHub Actionsæƒé™...');
          console.log('');
          
          // åŸºæœ¬ä¿¡æ¯
          console.log('ğŸ“Š åŸºæœ¬ä¿¡æ¯:');
          console.log(`- ä»“åº“: ${context.repo.owner}/${context.repo.repo}`);
          console.log(`- äº‹ä»¶ç±»å‹: ${context.eventName}`);
          console.log(`- Actor: ${context.actor}`);
          console.log(`- Run ID: ${context.runId}`);
          console.log('');
          
          // æƒé™æµ‹è¯•
          console.log('ğŸ” æƒé™æµ‹è¯•:');
          
          try {
            // æµ‹è¯•è¯»å–ä»“åº“ä¿¡æ¯
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            console.log('âœ… ä»“åº“è¯»å–æƒé™: æ­£å¸¸');
          } catch (error) {
            console.log('âŒ ä»“åº“è¯»å–æƒé™: å¤±è´¥', error.message);
          }
          
          // å¦‚æœæ˜¯PRäº‹ä»¶ï¼Œæµ‹è¯•PRç›¸å…³æƒé™
          if (context.eventName === 'pull_request') {
            try {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              console.log('âœ… PRè¯„è®ºè¯»å–æƒé™: æ­£å¸¸');
              
              // å°è¯•åˆ›å»ºæµ‹è¯•è¯„è®º
              const testComment = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: 'ğŸ¤– **æƒé™æµ‹è¯•è¯„è®º** - å¦‚æœæ‚¨çœ‹åˆ°è¿™æ¡è¯„è®ºï¼Œè¯´æ˜GitHub Actionså…·æœ‰æ­£ç¡®çš„PRè¯„è®ºæƒé™ã€‚\n\n*æ­¤è¯„è®ºå°†è¢«è‡ªåŠ¨åˆ é™¤*'
              });
              console.log('âœ… PRè¯„è®ºåˆ›å»ºæƒé™: æ­£å¸¸');
              
              // åˆ é™¤æµ‹è¯•è¯„è®º
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: testComment.data.id
              });
              console.log('âœ… PRè¯„è®ºåˆ é™¤æƒé™: æ­£å¸¸');
              
            } catch (error) {
              console.log('âŒ PRè¯„è®ºæƒé™æµ‹è¯•å¤±è´¥:', error.message);
              console.log('é”™è¯¯è¯¦æƒ…:', JSON.stringify(error, null, 2));
            }
          }
          
          // Actionsæƒé™æµ‹è¯•
          try {
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'library-compliance-check.yml',
              per_page: 1
            });
            console.log('âœ… Actionsè¯»å–æƒé™: æ­£å¸¸');
          } catch (error) {
            console.log('âŒ Actionsè¯»å–æƒé™: å¤±è´¥', error.message);
          }
          
          console.log('');
          console.log('ğŸ”§ å»ºè®®æ£€æŸ¥é¡¹:');
          console.log('1. Repository Settings â†’ Actions â†’ General â†’ Workflow permissions');
          console.log('2. Repository Settings â†’ Actions â†’ General â†’ Allow GitHub Actions to create and approve pull requests');
          console.log('3. Branch protection rules on main branch');