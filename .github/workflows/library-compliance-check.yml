name: Library Compliance Check

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '*/package.json'
      - '*/block.json'
      - '*/generator.js'
      - '*/toolbox.json'
      - '*/readme.md'
  push:
    branches: [ main, develop ]
    paths:
      - '*/package.json'
      - '*/block.json'
      - '*/generator.js'
      - '*/toolbox.json'
      - '*/readme.md'

# GitHub Actionsæƒé™é…ç½®
permissions:
  contents: read            # è¯»å–ä»“åº“å†…å®¹å’Œä»£ç 
  pull-requests: write      # å†™å…¥PRè¯„è®ºå’ŒçŠ¶æ€
  issues: write            # å†™å…¥issueè¯„è®ºï¼ˆPRä¹Ÿæ˜¯ç‰¹æ®Šçš„issueï¼‰
  actions: read            # è¯»å–workflowè¿è¡ŒçŠ¶æ€
  checks: read             # è¯»å–æ£€æŸ¥çŠ¶æ€
  statuses: read           # è¯»å–çŠ¶æ€æ£€æŸ¥

jobs:
  validate-libraries:
    runs-on: ubuntu-latest
    # åœ¨jobçº§åˆ«ä¹Ÿæ˜ç¡®æƒé™ï¼ˆå¯é€‰ï¼Œä½†æ›´å®‰å…¨ï¼‰
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install js-yaml

    - name: Validate changed libraries
      id: validation
      run: |
        echo "å¼€å§‹æ£€æµ‹å˜æ›´çš„åº“..."
        
        # ä½¿ç”¨ç»Ÿä¸€çš„æ£€æµ‹è„šæœ¬ï¼Œè‡ªåŠ¨è¯»å–é…ç½®æ–‡ä»¶
        if ! node validate-library-compliance.js --changed; then
          echo "validation_passed=false" >> $GITHUB_OUTPUT
          echo "ğŸ’¥ åº“è§„èŒƒæ£€æµ‹å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå¹¶ä¿®å¤é—®é¢˜"
          exit 1
        else
          echo "validation_passed=true" >> $GITHUB_OUTPUT
          echo "ğŸ‰ æ‰€æœ‰åº“å‡é€šè¿‡è§„èŒƒæ£€æµ‹ï¼"
        fi

    - name: Comment PR with results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ github.token }}
        retries: 3
        retry-exempt-status-codes: 400,401,403,404,422
        script: |
          console.log('ğŸ” å¼€å§‹PRè¯„è®ºæ“ä½œ...');
          
          try {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ£€æµ‹æœºå™¨äººè¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // æŸ¥æ‰¾ç°æœ‰çš„æ£€æµ‹è¯„è®º
            const botComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ¤– åº“è§„èŒƒæ£€æµ‹')
            );
            
            // è·å–æ£€æµ‹ç»“æœçŠ¶æ€
            const validationPassed = '${{ steps.validation.outputs.validation_passed }}' === 'true';
            const statusIcon = validationPassed ? 'âœ…' : 'âŒ';
            const statusText = validationPassed ? 'é€šè¿‡æ£€æµ‹' : 'æ£€æµ‹å¤±è´¥';
            
            // æ„å»ºè¯„è®ºå†…å®¹
            let comment = '## ğŸ¤– åº“è§„èŒƒæ£€æµ‹ ' + statusText + ' ' + statusIcon + '\n\n';
            comment += 'ğŸ“¦ **æ£€æµ‹æ¨¡å¼**: è‡ªåŠ¨æ£€æµ‹ PR ä¸­å˜æ›´çš„åº“\n\n';
            comment += 'ğŸ“Š **è¯¦ç»†æŠ¥å‘Š**: æŸ¥çœ‹ä¸Šæ–¹çš„ [Actions Summary](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) è·å–å®Œæ•´ç»“æœ\n\n';
            
            if (validationPassed) {
              comment += 'ğŸ‰ **æ­å–œï¼** æ‰€æœ‰å˜æ›´åº“å‡ç¬¦åˆè§„èŒƒè¦æ±‚ï¼\n\n';
              comment += 'âœ¨ **ä¸»è¦æ£€æµ‹é¡¹**:\n';
              comment += '- ğŸ“ æ–‡ä»¶ç»“æ„å®Œæ•´æ€§ âœ…\n';
              comment += '- ğŸ§© å—è®¾è®¡æœ€ä½³å®è·µ âœ…\n';
              comment += '- âš™ï¸ ä»£ç ç”Ÿæˆå™¨è§„èŒƒ âœ…\n';
              comment += '- ğŸ“š æ–‡æ¡£è§„èŒƒè¦æ±‚ âœ…\n';
            } else {
              comment += 'âš ï¸ **éœ€è¦ä¿®å¤** éƒ¨åˆ†åº“ä¸ç¬¦åˆè§„èŒƒè¦æ±‚\n\n';
              comment += 'ğŸ”§ **ä¿®å¤æ­¥éª¤**:\n';
              comment += '1. æŸ¥çœ‹ä¸Šæ–¹ Actions Summary çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯\n';
              comment += '2. å‚è€ƒä¸‹æ–¹è§„èŒƒæ–‡æ¡£è¿›è¡Œä¿®å¤\n';
              comment += '3. é‡æ–°æäº¤ä»£ç è§¦å‘æ£€æµ‹\n';
            }
            
            comment += '\nğŸ’¡ **æœ¬åœ°æ£€æµ‹**: \n';
            comment += '```bash\n';
            comment += '# æ£€æµ‹å˜æ›´çš„åº“\n';
            comment += 'node validate-library-compliance.js --changed\n\n';
            comment += '# æ£€æµ‹æŒ‡å®šåº“\n';
            comment += 'node validate-library-compliance.js <åº“å>\n';
            comment += '```\n\n';
            comment += 'ğŸ“– **è§„èŒƒæ–‡æ¡£**: \n';
            comment += '- [Arduinoåº“è½¬Blocklyåº“è§„èŒƒ](https://github.com/${{ github.repository }}/blob/main/Arduinoåº“è½¬Blocklyåº“è§„èŒƒ.md)\n';
            comment += '- [é…ç½®æ–‡ä»¶](.github/compliance-config.yml)\n\n';
            comment += '---\n';
            comment += '*æ£€æµ‹ç”± [åº“è§„èŒƒæ£€æµ‹ç³»ç»Ÿ](https://github.com/${{ github.repository }}/blob/main/validate-library-compliance.js) è‡ªåŠ¨å®Œæˆ | è¿è¡ŒID: ${{ github.run_id }}*';
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('âœ… å·²æ›´æ–°ç°æœ‰æ£€æµ‹è¯„è®º');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('âœ… å·²æ·»åŠ æ–°çš„æ£€æµ‹è¯„è®º');
            }
          } catch (error) {
            console.error('âŒ è¯„è®ºæ“ä½œå¤±è´¥:', error.message);
            console.log('ğŸ’¡ æ£€æµ‹ç»“æœå·²ä¿å­˜åœ¨ Actions Summary ä¸­');
          }

    # å¤‡ç”¨è¯„è®ºæ–¹æ¡ˆ - ä½¿ç”¨ç®€å•çš„echoè¾“å‡º
    - name: Fallback notification
      if: failure() && github.event_name == 'pull_request'
      run: |
        echo "ğŸ”” å¤‡ç”¨é€šçŸ¥æœºåˆ¶:"
        echo "ç”±äºæƒé™é™åˆ¶ï¼Œæ— æ³•ç›´æ¥åœ¨PRä¸­è¯„è®º"
        echo "è¯·è®¿é—®Actionsé¡µé¢æŸ¥çœ‹è¯¦ç»†çš„åº“è§„èŒƒæ£€æµ‹ç»“æœ"
        echo "é“¾æ¥: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"