name: Library Compliance Check

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '*/package.json'
      - '*/block.json'
      - '*/generator.js'
      - '*/toolbox.json'
      - '*/readme.md'
  push:
    branches: [ main, develop ]
    paths:
      - '*/package.json'
      - '*/block.json'
      - '*/generator.js'
      - '*/toolbox.json'
      - '*/readme.md'

# GitHub Actionsæƒé™é…ç½®
permissions:
  contents: read            # è¯»å–ä»“åº“å†…å®¹å’Œä»£ç 
  pull-requests: write      # å†™å…¥PRè¯„è®ºå’ŒçŠ¶æ€
  issues: write            # å†™å…¥issueè¯„è®ºï¼ˆPRä¹Ÿæ˜¯ç‰¹æ®Šçš„issueï¼‰
  actions: read            # è¯»å–workflowè¿è¡ŒçŠ¶æ€
  checks: read             # è¯»å–æ£€æŸ¥çŠ¶æ€
  statuses: read           # è¯»å–çŠ¶æ€æ£€æŸ¥

jobs:
  validate-libraries:
    runs-on: ubuntu-latest
    # åœ¨jobçº§åˆ«ä¹Ÿæ˜ç¡®æƒé™ï¼ˆå¯é€‰ï¼Œä½†æ›´å®‰å…¨ï¼‰
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Get changed libraries
      id: changed-libs
      run: |
        echo "æ£€æµ‹å˜æ›´çš„åº“æ–‡ä»¶..."
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # PRæ¨¡å¼ï¼šæ¯”è¾ƒPRåˆ†æ”¯ä¸ç›®æ ‡åˆ†æ”¯
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
        else
          # Pushæ¨¡å¼ï¼šæ¯”è¾ƒå½“å‰æäº¤ä¸ä¸Šä¸€ä¸ªæäº¤
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        fi
        
        echo "å˜æ›´çš„æ–‡ä»¶:"
        echo "$CHANGED_FILES"
        
        # æå–å˜æ›´çš„åº“ç›®å½•
        CHANGED_LIBRARIES=$(echo "$CHANGED_FILES" | grep -E '\.(json|js|md)$' | cut -d'/' -f1 | sort | uniq | grep -v '^$' | grep -v '^\.' || true)
        
        echo "å˜æ›´çš„åº“:"
        echo "$CHANGED_LIBRARIES"
        
        # è½¬æ¢ä¸ºé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²
        LIBS_LIST=$(echo "$CHANGED_LIBRARIES" | tr '\n' ',' | sed 's/,$//')
        echo "libraries=$LIBS_LIST" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æ£€æµ‹çš„åº“
        if [ -z "$LIBS_LIST" ]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Validate changed libraries
      if: steps.changed-libs.outputs.has_changes == 'true'
      id: validation
      run: |
        echo "å¼€å§‹æ£€æµ‹å˜æ›´çš„åº“..."
        
        # æ£€æŸ¥éªŒè¯è„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ ! -f "github-actions-validator.js" ]; then
          echo "âŒ é”™è¯¯: github-actions-validator.js è„šæœ¬ä¸å­˜åœ¨"
          exit 1
        fi
        
        # è®¾ç½®éªŒè¯ç»“æœå˜é‡
        VALIDATION_PASSED="true"
        
        # ä½¿ç”¨æ–°çš„GitHub ActionséªŒè¯å™¨
        if [ -n "${{ steps.changed-libs.outputs.libraries }}" ]; then
          # å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºç©ºæ ¼åˆ†éš”çš„å‚æ•°
          LIBS="${{ steps.changed-libs.outputs.libraries }}"
          LIBS_ARGS=$(echo "$LIBS" | tr ',' ' ')
          
          echo "æ£€æµ‹åº“: $LIBS_ARGS"
          if ! node github-actions-validator.js $LIBS_ARGS; then
            VALIDATION_PASSED="false"
          fi
        else
          echo "ä½¿ç”¨Gitå˜æ›´æ£€æµ‹æ¨¡å¼"
          if ! node github-actions-validator.js --changed; then
            VALIDATION_PASSED="false"
          fi
        fi
        
        echo "validation_passed=$VALIDATION_PASSED" >> $GITHUB_OUTPUT
        
        # å¦‚æœéªŒè¯å¤±è´¥ï¼Œè®¾ç½®éé›¶é€€å‡ºç 
        if [ "$VALIDATION_PASSED" = "false" ]; then
          echo "ğŸ’¥ åº“è§„èŒƒæ£€æµ‹å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå¹¶ä¿®å¤é—®é¢˜"
          exit 1
        else
          echo "ğŸ‰ æ‰€æœ‰åº“å‡é€šè¿‡è§„èŒƒæ£€æµ‹ï¼"
        fi

    - name: No changes detected
      if: steps.changed-libs.outputs.has_changes == 'false'
      run: |
        echo "â„¹ï¸ æœªæ£€æµ‹åˆ°éœ€è¦éªŒè¯çš„åº“æ–‡ä»¶å˜æ›´"
        echo "å˜æ›´æ£€æµ‹èŒƒå›´: package.json, block.json, generator.js, toolbox.json, readme.md"

    - name: Comment PR with results
      if: github.event_name == 'pull_request' && steps.changed-libs.outputs.has_changes == 'true'
      uses: actions/github-script@v7
      with:
        # æ˜ç¡®æŒ‡å®šGitHub Tokenï¼Œç¡®ä¿æƒé™æ­£ç¡®
        github-token: ${{ github.token }}
        # è®¾ç½®é‡è¯•æœºåˆ¶
        retries: 3
        retry-exempt-status-codes: 400,401,403,404,422
        script: |
          console.log('ğŸ” å¼€å§‹PRè¯„è®ºæ“ä½œ...');
          console.log(`ä»“åº“: ${context.repo.owner}/${context.repo.repo}`);
          console.log(`PRå·: ${context.issue.number}`);
          console.log(`äº‹ä»¶ç±»å‹: ${context.eventName}`);
          console.log(`Actor: ${context.actor}`);
          
          // éªŒè¯åŸºæœ¬æƒé™
          console.log('ğŸ” éªŒè¯åŸºæœ¬æƒé™...');
          try {
            const repoInfo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            console.log('âœ… ä»“åº“è¯»å–æƒé™æ­£å¸¸');
          } catch (permError) {
            console.error('âŒ åŸºæœ¬æƒé™éªŒè¯å¤±è´¥:', permError.message);
            throw new Error(`æƒé™ä¸è¶³: ${permError.message}`);
          }
          
          try {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ£€æµ‹æœºå™¨äººè¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // æŸ¥æ‰¾ç°æœ‰çš„æ£€æµ‹è¯„è®º
            const botComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ¤– åº“è§„èŒƒæ£€æµ‹')
            );
            
            // è·å–æ£€æµ‹ç»“æœçŠ¶æ€
            const validationPassed = '${{ steps.validation.outputs.validation_passed }}' === 'true';
            const statusIcon = validationPassed ? 'âœ…' : 'âŒ';
            const statusText = validationPassed ? 'é€šè¿‡æ£€æµ‹' : 'æ£€æµ‹å¤±è´¥';
            const changedLibs = '${{ steps.changed-libs.outputs.libraries }}';
            
            const comment = "## ğŸ¤– åº“è§„èŒƒæ£€æµ‹" + statusText + " " + statusIcon + "\n\n" +
            (changedLibs ? "ğŸ“¦ **æ£€æµ‹èŒƒå›´**: " + changedLibs.replace(/,/g, ', ') : "ğŸ“¦ **æ£€æµ‹æ¨¡å¼**: Gitå˜æ›´æ£€æµ‹") + "\n\n" +
            "ğŸ“Š **è¯¦ç»†æŠ¥å‘Š**: æŸ¥çœ‹ä¸Šæ–¹çš„ [Actions Summary](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) è·å–å®Œæ•´ç»“æœ\n\n" +
            (validationPassed ? 
              "ğŸ‰ **æ­å–œï¼** æ‰€æœ‰å˜æ›´åº“å‡ç¬¦åˆè§„èŒƒè¦æ±‚ï¼\n\n" +
              "âœ¨ **ä¸»è¦æ£€æµ‹é¡¹**:\n" +
              "- ğŸ“ æ–‡ä»¶ç»“æ„å®Œæ•´æ€§ âœ…\n" +
              "- ğŸ§© å—è®¾è®¡æœ€ä½³å®è·µ âœ…\n" +  
              "- âš™ï¸ ä»£ç ç”Ÿæˆå™¨è§„èŒƒ âœ…\n" +
              "- ğŸ“š æ–‡æ¡£è§„èŒƒè¦æ±‚ âœ…" :
              "âš ï¸ **éœ€è¦ä¿®å¤** éƒ¨åˆ†åº“ä¸ç¬¦åˆè§„èŒƒè¦æ±‚\n\n" +
              "ğŸ”§ **ä¿®å¤æ­¥éª¤**:\n" +
              "1. æŸ¥çœ‹ä¸Šæ–¹Actions Summaryçš„è¯¦ç»†é”™è¯¯ä¿¡æ¯\n" +
              "2. å‚è€ƒä¸‹æ–¹è§„èŒƒæ–‡æ¡£è¿›è¡Œä¿®å¤\n" +
              "3. é‡æ–°æäº¤ä»£ç è§¦å‘æ£€æµ‹"
            ) + "\n\n" +
            "ğŸ’¡ **æœ¬åœ°æ£€æµ‹**: \n" +
            "```bash\n" +
            "# æ£€æµ‹æŒ‡å®šåº“\n" +
            "node validate-library-compliance.js <åº“å>\n\n" +
            "# æ£€æµ‹æ‰€æœ‰åº“\n" +
            "node validate-library-compliance.js --all\n" +
            "```\n\n" +
            "ğŸ“– **è§„èŒƒæ–‡æ¡£**: \n" +
            "- [Arduinoåº“è½¬Blocklyåº“è§„èŒƒ](https://github.com/${{ github.repository }}/blob/main/Arduinoåº“è½¬Blocklyåº“è§„èŒƒ.md)\n" +
            "- [Blocklyåº“READMEç¼–å†™è§„èŒƒ](https://github.com/${{ github.repository }}/blob/main/blocklyåº“readmeç¼–å†™è§„èŒƒ.md)\n\n" +
            "---\n" +
            "*æ£€æµ‹ç”± [åº“è§„èŒƒæ£€æµ‹ç³»ç»Ÿ v2.0](https://github.com/${{ github.repository }}/blob/main/validate-library-compliance.js) è‡ªåŠ¨å®Œæˆ | è¿è¡ŒID: ${{ github.run_id }}*";
            
            if (botComment) {
              // æ›´æ–°ç°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('âœ… å·²æ›´æ–°ç°æœ‰æ£€æµ‹è¯„è®º');
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('âœ… å·²æ·»åŠ æ–°çš„æ£€æµ‹è¯„è®º');
            }
          } catch (error) {
            console.error('âŒ è¯„è®ºæ“ä½œå¤±è´¥:', error.message);
            console.error('é”™è¯¯çŠ¶æ€ç :', error.status);
            console.error('é”™è¯¯è¯¦æƒ…:', JSON.stringify(error.response?.data || error, null, 2));
            
            // è¯¦ç»†æƒé™è¯Šæ–­
            console.log('');
            console.log('ğŸ”§ è¯¦ç»†æƒé™è¯Šæ–­:');
            console.log(`é”™è¯¯ç±»å‹: ${error.name}`);
            console.log(`HTTPçŠ¶æ€: ${error.status}`);
            console.log(`è¯·æ±‚URL: ${error.request?.url || 'unknown'}`);
            
            // æ ¹æ®é”™è¯¯ç±»å‹æä¾›å…·ä½“å»ºè®®
            if (error.status === 403) {
              console.log('');
              console.log('ğŸš¨ 403æƒé™é”™è¯¯ - æ£€æŸ¥ä»¥ä¸‹è®¾ç½®:');
              console.log('1. ä»“åº“è®¾ç½® â†’ Actions â†’ General â†’ Workflow permissions');
              console.log('   âœ… åº”é€‰æ‹©: "Read and write permissions"');
              console.log('2. ä»“åº“è®¾ç½® â†’ Actions â†’ General');
              console.log('   âœ… å¯ç”¨: "Allow GitHub Actions to create and approve pull requests"');
              console.log('3. åˆ†æ”¯ä¿æŠ¤è§„åˆ™ä¸åº”é˜»æ­¢botæ“ä½œ');
              console.log('4. ç¡®è®¤ä»“åº“ä¸æ˜¯privateä¸”actionsæœ‰è¶³å¤Ÿæƒé™');
              
              // æ£€æŸ¥tokenç±»å‹
              console.log('');
              console.log('ğŸ”‘ Tokenè¯Šæ–­:');
              console.log(`ä½¿ç”¨çš„token: github.token (æ¨è)`);
              console.log(`ä¸Šä¸‹æ–‡actor: ${context.actor}`);
            }
            
            // ä¸è®©è¯„è®ºå¤±è´¥é˜»æ­¢æ•´ä¸ªworkflow
            console.log('');
            console.log('ğŸ’¡ æ£€æµ‹ç»“æœå·²ä¿å­˜åœ¨Actions Summaryä¸­');
            console.log('ğŸ’¡ å¯ä»¥æ‰‹åŠ¨æŸ¥çœ‹workflowè¿è¡Œç»“æœ');
            
            // è®¾ç½®workflowçŠ¶æ€ï¼Œå³ä½¿è¯„è®ºå¤±è´¥ä¹Ÿä¸å½±å“æ£€æµ‹ç»“æœ
            console.log('ç»§ç»­æ‰§è¡Œworkflow...');
          }

    # å¤‡ç”¨è¯„è®ºæ–¹æ¡ˆ - ä½¿ç”¨ç®€å•çš„echoè¾“å‡º
    - name: Fallback notification
      if: failure() && github.event_name == 'pull_request'
      run: |
        echo "ğŸ”” å¤‡ç”¨é€šçŸ¥æœºåˆ¶:"
        echo "ç”±äºæƒé™é™åˆ¶ï¼Œæ— æ³•ç›´æ¥åœ¨PRä¸­è¯„è®º"
        echo "è¯·è®¿é—®Actionsé¡µé¢æŸ¥çœ‹è¯¦ç»†çš„åº“è§„èŒƒæ£€æµ‹ç»“æœ"
        echo "é“¾æ¥: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"