name: Library Compliance Check

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '*/package.json'
      - '*/block.json'
      - '*/generator.js'
      - '*/toolbox.json'
      - '*/readme.md'
  push:
    branches: [ main, develop ]
    paths:
      - '*/package.json'
      - '*/block.json'
      - '*/generator.js'
      - '*/toolbox.json'
      - '*/readme.md'

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: read          # è¯»å–ä»“åº“å†…å®¹
  pull-requests: write    # å†™å…¥PRè¯„è®º
  issues: write          # å†™å…¥issueè¯„è®ºï¼ˆPRä¹Ÿæ˜¯issueï¼‰
  actions: read          # è¯»å–actionsçŠ¶æ€

jobs:
  validate-libraries:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Get changed libraries
      id: changed-libs
      run: |
        echo "æ£€æµ‹å˜æ›´çš„åº“æ–‡ä»¶..."
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # PRæ¨¡å¼ï¼šæ¯”è¾ƒPRåˆ†æ”¯ä¸ç›®æ ‡åˆ†æ”¯
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
        else
          # Pushæ¨¡å¼ï¼šæ¯”è¾ƒå½“å‰æäº¤ä¸ä¸Šä¸€ä¸ªæäº¤
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        fi
        
        echo "å˜æ›´çš„æ–‡ä»¶:"
        echo "$CHANGED_FILES"
        
        # æå–å˜æ›´çš„åº“ç›®å½•
        CHANGED_LIBRARIES=$(echo "$CHANGED_FILES" | grep -E '\.(json|js|md)$' | cut -d'/' -f1 | sort | uniq | grep -v '^$' | grep -v '^\.' || true)
        
        echo "å˜æ›´çš„åº“:"
        echo "$CHANGED_LIBRARIES"
        
        # è½¬æ¢ä¸ºé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²
        LIBS_LIST=$(echo "$CHANGED_LIBRARIES" | tr '\n' ',' | sed 's/,$//')
        echo "libraries=$LIBS_LIST" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æ£€æµ‹çš„åº“
        if [ -z "$LIBS_LIST" ]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Validate changed libraries
      if: steps.changed-libs.outputs.has_changes == 'true'
      id: validation
      run: |
        echo "å¼€å§‹æ£€æµ‹å˜æ›´çš„åº“..."
        
        # æ£€æŸ¥éªŒè¯è„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ ! -f "github-actions-validator.js" ]; then
          echo "âŒ é”™è¯¯: github-actions-validator.js è„šæœ¬ä¸å­˜åœ¨"
          exit 1
        fi
        
        # è®¾ç½®éªŒè¯ç»“æœå˜é‡
        VALIDATION_PASSED="true"
        
        # ä½¿ç”¨æ–°çš„GitHub ActionséªŒè¯å™¨
        if [ -n "${{ steps.changed-libs.outputs.libraries }}" ]; then
          # å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºç©ºæ ¼åˆ†éš”çš„å‚æ•°
          LIBS="${{ steps.changed-libs.outputs.libraries }}"
          LIBS_ARGS=$(echo "$LIBS" | tr ',' ' ')
          
          echo "æ£€æµ‹åº“: $LIBS_ARGS"
          if ! node github-actions-validator.js $LIBS_ARGS; then
            VALIDATION_PASSED="false"
          fi
        else
          echo "ä½¿ç”¨Gitå˜æ›´æ£€æµ‹æ¨¡å¼"
          if ! node github-actions-validator.js --changed; then
            VALIDATION_PASSED="false"
          fi
        fi
        
        echo "validation_passed=$VALIDATION_PASSED" >> $GITHUB_OUTPUT
        
        # å¦‚æœéªŒè¯å¤±è´¥ï¼Œè®¾ç½®éé›¶é€€å‡ºç 
        if [ "$VALIDATION_PASSED" = "false" ]; then
          echo "ğŸ’¥ åº“è§„èŒƒæ£€æµ‹å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå¹¶ä¿®å¤é—®é¢˜"
          exit 1
        else
          echo "ğŸ‰ æ‰€æœ‰åº“å‡é€šè¿‡è§„èŒƒæ£€æµ‹ï¼"
        fi

    - name: No changes detected
      if: steps.changed-libs.outputs.has_changes == 'false'
      run: |
        echo "â„¹ï¸ æœªæ£€æµ‹åˆ°éœ€è¦éªŒè¯çš„åº“æ–‡ä»¶å˜æ›´"
        echo "å˜æ›´æ£€æµ‹èŒƒå›´: package.json, block.json, generator.js, toolbox.json, readme.md"

    - name: Comment PR with results
      if: github.event_name == 'pull_request' && steps.changed-libs.outputs.has_changes == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          try {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ£€æµ‹æœºå™¨äººè¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // æŸ¥æ‰¾ç°æœ‰çš„æ£€æµ‹è¯„è®º
            const botComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ¤– åº“è§„èŒƒæ£€æµ‹')
            );
            
            // è·å–æ£€æµ‹ç»“æœçŠ¶æ€
            const validationPassed = '${{ steps.validation.outputs.validation_passed }}' === 'true';
            const statusIcon = validationPassed ? 'âœ…' : 'âŒ';
            const statusText = validationPassed ? 'é€šè¿‡æ£€æµ‹' : 'æ£€æµ‹å¤±è´¥';
            const changedLibs = '${{ steps.changed-libs.outputs.libraries }}';
            
            const comment = `## ğŸ¤– åº“è§„èŒƒæ£€æµ‹${statusText} ${statusIcon}
            
${changedLibs ? `ğŸ“¦ **æ£€æµ‹èŒƒå›´**: ${changedLibs.replace(/,/g, ', ')}` : 'ï¿½ **æ£€æµ‹æ¨¡å¼**: Gitå˜æ›´æ£€æµ‹'}

ğŸ“Š **è¯¦ç»†æŠ¥å‘Š**: æŸ¥çœ‹ä¸Šæ–¹çš„ [Actions Summary](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) è·å–å®Œæ•´ç»“æœ

${validationPassed ? 
`ğŸ‰ **æ­å–œï¼** æ‰€æœ‰å˜æ›´åº“å‡ç¬¦åˆè§„èŒƒè¦æ±‚ï¼

âœ¨ **ä¸»è¦æ£€æµ‹é¡¹**:
- ğŸ“ æ–‡ä»¶ç»“æ„å®Œæ•´æ€§ âœ…
- ğŸ§© å—è®¾è®¡æœ€ä½³å®è·µ âœ…  
- âš™ï¸ ä»£ç ç”Ÿæˆå™¨è§„èŒƒ âœ…
- ğŸ“š æ–‡æ¡£è§„èŒƒè¦æ±‚ âœ…` :
`âš ï¸ **éœ€è¦ä¿®å¤** éƒ¨åˆ†åº“ä¸ç¬¦åˆè§„èŒƒè¦æ±‚

ğŸ”§ **ä¿®å¤æ­¥éª¤**:
1. æŸ¥çœ‹ä¸Šæ–¹Actions Summaryçš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
2. å‚è€ƒä¸‹æ–¹è§„èŒƒæ–‡æ¡£è¿›è¡Œä¿®å¤
3. é‡æ–°æäº¤ä»£ç è§¦å‘æ£€æµ‹`}

ğŸ’¡ **æœ¬åœ°æ£€æµ‹**: 
\`\`\`bash
# æ£€æµ‹æŒ‡å®šåº“
node validate-library-compliance.js <åº“å>

# æ£€æµ‹æ‰€æœ‰åº“  
node validate-library-compliance.js --all
\`\`\`

ğŸ“– **è§„èŒƒæ–‡æ¡£**: 
- [Arduinoåº“è½¬Blocklyåº“è§„èŒƒ](https://github.com/${{ github.repository }}/blob/main/Arduinoåº“è½¬Blocklyåº“è§„èŒƒ.md)
- [Blocklyåº“READMEç¼–å†™è§„èŒƒ](https://github.com/${{ github.repository }}/blob/main/blocklyåº“readmeç¼–å†™è§„èŒƒ.md)

---
*æ£€æµ‹ç”± [åº“è§„èŒƒæ£€æµ‹ç³»ç»Ÿ v2.0](https://github.com/${{ github.repository }}/blob/main/validate-library-compliance.js) è‡ªåŠ¨å®Œæˆ | è¿è¡ŒID: ${{ github.run_id }}*`;
            
            if (botComment) {
              // æ›´æ–°ç°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('âœ… å·²æ›´æ–°ç°æœ‰æ£€æµ‹è¯„è®º');
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('âœ… å·²æ·»åŠ æ–°çš„æ£€æµ‹è¯„è®º');
            }
          } catch (error) {
            console.error('âŒ è¯„è®ºæ“ä½œå¤±è´¥:', error.message);
            // ä¸è®©è¯„è®ºå¤±è´¥é˜»æ­¢æ•´ä¸ªworkflow
            console.log('ğŸ’¡ è¯·æŸ¥çœ‹Actions Summaryè·å–æ£€æµ‹ç»“æœ');
          }