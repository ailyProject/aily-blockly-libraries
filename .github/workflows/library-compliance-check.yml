name: Library Compliance Check

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '*/package.json'
      - '*/block.json'
      - '*/generator.js'
      - '*/toolbox.json'
      - '*/readme.md'
  push:
    branches: [ main, develop ]
    paths:
      - '*/package.json'
      - '*/block.json'
      - '*/generator.js'
      - '*/toolbox.json'
      - '*/readme.md'

jobs:
  validate-libraries:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Get changed libraries
      id: changed-libs
      run: |
        echo "æ£€æµ‹å˜æ›´çš„åº“æ–‡ä»¶..."
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # PRæ¨¡å¼ï¼šæ¯”è¾ƒPRåˆ†æ”¯ä¸ç›®æ ‡åˆ†æ”¯
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
        else
          # Pushæ¨¡å¼ï¼šæ¯”è¾ƒå½“å‰æäº¤ä¸ä¸Šä¸€ä¸ªæäº¤
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        fi
        
        echo "å˜æ›´çš„æ–‡ä»¶:"
        echo "$CHANGED_FILES"
        
        # æå–å˜æ›´çš„åº“ç›®å½•
        CHANGED_LIBRARIES=$(echo "$CHANGED_FILES" | grep -E '\.(json|js|md)$' | cut -d'/' -f1 | sort | uniq | grep -v '^$' | grep -v '^\.' || true)
        
        echo "å˜æ›´çš„åº“:"
        echo "$CHANGED_LIBRARIES"
        
        # è½¬æ¢ä¸ºé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²
        LIBS_LIST=$(echo "$CHANGED_LIBRARIES" | tr '\n' ',' | sed 's/,$//')
        echo "libraries=$LIBS_LIST" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æ£€æµ‹çš„åº“
        if [ -z "$LIBS_LIST" ]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Validate changed libraries
      if: steps.changed-libs.outputs.has_changes == 'true'
      run: |
        echo "å¼€å§‹æ£€æµ‹å˜æ›´çš„åº“..."
        
        # ä½¿ç”¨æ–°çš„GitHub ActionséªŒè¯å™¨
        if [ -n "${{ steps.changed-libs.outputs.libraries }}" ]; then
          # å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºç©ºæ ¼åˆ†éš”çš„å‚æ•°
          LIBS="${{ steps.changed-libs.outputs.libraries }}"
          LIBS_ARGS=$(echo "$LIBS" | tr ',' ' ')
          
          echo "æ£€æµ‹åº“: $LIBS_ARGS"
          node github-actions-validator.js $LIBS_ARGS
        else
          echo "ä½¿ç”¨Gitå˜æ›´æ£€æµ‹æ¨¡å¼"
          node github-actions-validator.js --changed
        fi

    - name: No changes detected
      if: steps.changed-libs.outputs.has_changes == 'false'
      run: |
        echo "â„¹ï¸ æœªæ£€æµ‹åˆ°éœ€è¦éªŒè¯çš„åº“æ–‡ä»¶å˜æ›´"
        echo "å˜æ›´æ£€æµ‹èŒƒå›´: package.json, block.json, generator.js, toolbox.json, readme.md"

    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          // PRè¯„è®ºå°†é€šè¿‡GitHub Actions Summaryè‡ªåŠ¨ç”Ÿæˆ
          // è¿™é‡Œæ·»åŠ ä¸€ä¸ªç®€å•çš„çŠ¶æ€è¯„è®º
          const comment = `## ğŸ¤– åº“è§„èŒƒæ£€æµ‹å®Œæˆ
          
          ğŸ“Š **æ£€æµ‹æŠ¥å‘Š**: æŸ¥çœ‹ä¸Šæ–¹çš„Actionsæ‘˜è¦è·å–è¯¦ç»†ç»“æœ
          
          ğŸ’¡ **æœ¬åœ°æ£€æµ‹**: è¿è¡Œ \`node validate-library-compliance.js <åº“å>\` è·å–è¯¦ç»†ä¿¡æ¯
          
          ğŸ“– **è§„èŒƒæ–‡æ¡£**: å‚è€ƒé¡¹ç›®ä¸­çš„è§„èŒƒæ–‡æ¡£äº†è§£æœ€ä½³å®è·µ`;
          
          // å‘å¸ƒè¯„è®º
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });