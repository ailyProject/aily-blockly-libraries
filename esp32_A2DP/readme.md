# ESP32 蓝牙音频 (A2DP) Blockly库

基于 [ESP32-A2DP](https://github.com/pschatzmann/ESP32-A2DP) 库的Blockly图形化编程实现。

## 功能概述

本库提供ESP32蓝牙A2DP(Advanced Audio Distribution Profile)音频传输功能，支持：

### 🎧 蓝牙音频接收器 (Sink)
- 将ESP32变成蓝牙音箱，接收手机等设备的音频
- 支持I2S外部DAC和ESP32内置DAC输出
- AVRC播放控制（播放、暂停、停止、上一曲、下一曲）
- 音量控制
- 元数据回调（获取歌曲标题、艺术家等信息）
- 连接和音频状态监控

### 📻 蓝牙音频发送器 (Source)
- 将ESP32变成音频发送设备
- 可连接到蓝牙耳机、音箱等设备
- 支持自定义音频数据回调
- 自动重连功能

## 硬件要求

- **开发板**: ESP32系列（ESP32、ESP32-S3等）
- **音频输出**:
  - I2S外部DAC（如PCM5102、MAX98357等）
  - ESP32内置DAC（GPIO25/GPIO26）

## 快速开始

### 示例1：简单蓝牙音箱（使用内置DAC）

```blockly
1. 创建蓝牙音频接收器 a2dp_sink 输出到 内置DAC
2. 启动蓝牙音频接收器 a2dp_sink 设备名称 "MyMusic"
```

生成代码：
```cpp
#include "AudioTools.h"
#include "BluetoothA2DPSink.h"

AnalogAudioStream a2dp_sink_dac;
BluetoothA2DPSink a2dp_sink(a2dp_sink_dac);

void setup() {
  a2dp_sink.start("MyMusic");
}

void loop() {
}
```

### 示例2：带元数据显示的蓝牙音箱

```blockly
1. 创建蓝牙音频接收器 a2dp_sink 输出到 I2S外部DAC
2. 启动蓝牙音频接收器 a2dp_sink 设备名称 "SmartSpeaker"
3. 接收器 a2dp_sink 收到元数据时执行
   ID: metadata_id  内容: metadata_text
   执行:
     - 串口输出 "收到元数据"
     - 串口输出 metadata_id
     - 串口输出 metadata_text
```

### 示例3：播放控制

```blockly
在循环中:
  如果 获取音频状态 a2dp_sink == 音频状态_正在播放
    延时 10000 毫秒
    暂停 a2dp_sink
    延时 5000 毫秒
    播放 a2dp_sink
```

## 块说明

### 蓝牙音频接收器块

#### 创建蓝牙音频接收器
- **参数**:
  - 变量名: 接收器对象名称
  - 输出类型: I2S外部DAC / 内置DAC
- **说明**: 创建蓝牙A2DP音频接收器对象

#### 启动蓝牙音频接收器
- **参数**:
  - 接收器对象
  - 设备名称: 蓝牙显示的名称
- **说明**: 启动蓝牙服务，手机可以搜索到此名称

#### 播放控制块
- **播放**: 发送播放命令
- **暂停**: 发送暂停命令
- **停止**: 发送停止命令
- **下一曲**: 切换到下一首
- **上一曲**: 切换到上一首

#### 音量控制
- **设置音量**: 0-127，其中127为最大音量
- **获取音量**: 返回当前音量值

#### 事件回调
- **收到元数据时执行**: 接收歌曲信息（标题、艺术家、专辑等）
- **连接状态改变时执行**: 监控蓝牙连接状态
- **音频状态改变时执行**: 监控播放/暂停状态

#### 状态查询
- **获取音频状态**: 返回当前播放状态值

### 蓝牙音频发送器块

#### 创建蓝牙音频发送器
- **参数**: 变量名
- **说明**: 创建蓝牙A2DP音频发送器对象

#### 启动蓝牙音频发送器
- **参数**:
  - 发送器对象
  - 目标设备名称: 要连接的蓝牙设备名称
- **说明**: 启动发送器并连接到目标设备

#### 请求音频数据时执行
- **参数**:
  - 数据缓冲: Frame数组指针
  - 帧数: 请求的帧数量
- **说明**: 当需要音频数据时调用，需填充音频数据到缓冲区

#### 设置自动重连
- **参数**: 启用/禁用
- **说明**: 是否自动重连到上次连接的设备

### 常量块

- **音频状态_正在播放**: ESP_A2D_AUDIO_STATE_STARTED
- **音频状态_已停止**: ESP_A2D_AUDIO_STATE_STOPPED
- **音频状态_远程暂停**: ESP_A2D_AUDIO_STATE_REMOTE_SUSPEND

## I2S引脚配置

使用I2S外部DAC时，默认引脚为：
- BCK (位时钟): GPIO 14
- WS (字选择): GPIO 15
- DATA (数据): GPIO 22

如需修改引脚，需要使用AudioTools库的配置功能。

## 内置DAC引脚

ESP32内置DAC输出引脚：
- 右声道: GPIO25
- 左声道: GPIO26

## 注意事项

1. **音频质量**: I2S外部DAC通常比内置DAC音质更好
2. **电源**: 外接功放或音箱时注意电源供应充足
3. **蓝牙配对**: 首次连接需要在手机上搜索并配对ESP32设备
4. **延迟**: A2DP协议存在一定音频延迟，不适合实时应用
5. **内存**: 音频处理需要较多内存，注意ESP32内存使用
6. **板卡支持**: 仅支持ESP32系列，不支持ESP8266

## 依赖库

本Blockly库依赖以下Arduino库：
- **ESP32-A2DP**: 核心蓝牙A2DP库
- **AudioTools**: 音频流处理库（可选，建议使用）

这些库会在编译时自动包含。

## 常见问题

### Q: 手机搜索不到ESP32设备？
A: 确保ESP32已正确启动蓝牙服务，检查串口输出是否有错误信息。

### Q: 连接后没有声音？
A: 检查硬件连接是否正确，特别是I2S引脚。使用内置DAC时确认GPIO25/26连接到音频输入。

### Q: 音质不好或有杂音？
A: 建议使用I2S外部DAC，内置DAC音质有限。检查电源质量和接地。

### Q: 如何修改I2S引脚？
A: 当前简化版本使用默认引脚，高级配置需要直接使用Arduino代码。

## 技术支持

- 原库地址: https://github.com/pschatzmann/ESP32-A2DP
- AudioTools库: https://github.com/pschatzmann/arduino-audio-tools

## 版本历史

- v1.0.0 (2025-10): 初始版本
  - 支持蓝牙音频接收器(Sink)
  - 支持蓝牙音频发送器(Source)
  - AVRC播放控制
  - 元数据回调
  - 状态监控

## 许可证

本Blockly库遵循原ESP32-A2DP库的Apache License 2.0许可证。
